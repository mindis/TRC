import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;

import TransactionManager.*;
import DataManager.*;
import Scheduler.*;

public class Main {
	public static void main(String[] args) {

		System.out.println("*** PittHN starts executing ***");
		
		
		//TEST TODO
		DM.tables = "X,Y".split(",");
		TM.codes = new String[]{ "test/shortReadTrx.txt" };
		//Test end
		
		/*
		 * Getting input from user
		 */
//		 System.out.println("Please input your script(transaction) files, separated by comma (,): ");
//		 String tmp = getInput();
//		 TM.codes = tmp.split(",");
//		
//		 int flag;
//		 do{
//			 flag =1;
//			 System.out.println("Please input the buffer size (in Pages), the fefault value is 524288 bytes: ");
//			 tmp = getInput();
//		 try{
//			 DM.bufferSize = Integer.parseInt(tmp);
//		 }catch(Exception e){
//			 flag = 0;
//			 System.out.println("Invalid input.");
//		 }
//		 }while(flag==0);
//		
//		 System.out.println("Please input your tables' names, separated by comma (,): ");
//		 tmp = getInput();
//		 DM.tables = tmp.split(",");
//		 for(int i=0;i<DM.tables.length;i++){
//			 DM.tables[i] = DM.tables[i].trim();
//		 }
//		
//		
//		 do{
//		 flag =1;
//		 System.out.println("Please input the seed of the random number generator: ");
//		 tmp = getInput();
//		 try{
//			 TM.randomSeed = Integer.parseInt(tmp);
//		 }catch(Exception e){
//			 flag = 0;
//			 System.out.println("Invalid input.");
//		 }
//		 }while(flag==0);
//		
//		System.out.println("Please select concurrent reading option. Enter 0 for round robin, anything else for random. The default option is round robin");
//		tmp = getInput();
//		if(!tmp.equals("0")){
//			TM.concurrentReadOption = 2;
//		}
		
		
		 /*
		  * Initialization
		  */
		 System.out.println("[Initialization] starts");
		 
		 for(int i=0;i<DM.tables.length;i++){
			 L1_delta.tablePages.put(DM.tables[i], new ArrayList());
			 L2_delta.tablePages.put(DM.tables[i]+"-ClientName", new ArrayList());
			 L2_delta.tablePages.put(DM.tables[i]+"-Phone", new ArrayList());
			 Disk.tablePages.put(DM.tables[i]+"-ClientName", new ArrayList());
			 Disk.tablePages.put(DM.tables[i]+"-Phone", new ArrayList());
		 }
		 
		 System.out.println("Start to load data from data tables.");
		 ArrayList loadInst = Utils.loadData(DM.tables);
		 DM.execute(loadInst);
		 System.out.println("All the initial data have been loaded to PittHN.");
		
		
		System.out.println("\n[Transaction Manager]");
		TM.execute();
		if(TM.instructionList.size()<1){
			System.out.println("No transactions received. ");
			System.out.println("*** PittHN finishes executing ***");
			System.exit(0);
		}
		
		System.out.println("\n[Scheduler] starts");
		//TODO Scheduler
		//Data passed from TM: TM.instructionList
		//Data passed to Data Manager:  DM.execute(ArrayList<instructions> inst)
		
		DM.execute(TM.instructionList);
		
		System.out.println("*** PittHN finishes executing ***");
		
	}
	
	
	public static String getInput(){
		String str="";
		 try {
	            InputStreamReader is_reader = new InputStreamReader(System.in);
	            str = new BufferedReader(is_reader).readLine();
	            
	        } catch (IOException e) {
	            e.printStackTrace();
	        }
		 return str.trim();
	}

}
